\ProvidesPackage{umath2e}

% font loading commands

\ifdefined\directlua

\RequirePackage{luaotfload}

\directlua{
require('font-callback-mapping.lua')
}

\newcommand\umath@fonthook[1]{%
  \edef\@tmpa{#1}\def\@tmpb{}%
  \ifx\@tmpa\@tmpb\else
    \directlua{mathmapstr = '#1'}%
  \fi}

\def\extract@font{%
  \get@external@font
  \csname \curr@fontshape+preloadhook\endcsname
  \global\expandafter\font\font@name\external@font\relax
  \font@name \relax
  \csname \f@encoding+\f@family \endcsname
  \csname \curr@fontshape       \endcsname
  \umath@fonthook{nil}
  \relax
}

\fi

\RequirePackage[TU]{fontenc}

\begingroup
  \normalsize
  \calculate@math@sizes
  \csname S@\f@size\endcsname
  \xdef\umath@sf{\strip@pt\dimexpr0.5\dimexpr\ssf@size pt+\sf@size pt\relax\relax}
  \xdef\umath@tf{\strip@pt\dimexpr0.5\dimexpr \sf@size pt+\tf@size pt\relax\relax}
\endgroup

\newcommand\mathencodingdefault{TU}
\newcommand\mathseriesdefault{m}
\newcommand\mathshapedefault{m}

\newcount\umath@scalecount
\umath@scalecount=0\relax

\newcommand\DeclareMathFamily[3]{%
  \def\umath@fontname{#1}%
  \def\@tmpa{#3}\def\@tmpb{}%
  \ifx\@tmpa\@tmpb
    \def\umath@family{#2}%
  \else
    \def\umath@family{#2-map-#3}%
  \fi
  \edef\umathfontdecl{[\umath@fontname]}%
  \edef\umath@mode;{\ifdefined\directlua mode=base;\fi}%
  \edef\umath@mapping;{\ifdefined\directlua\else mapping=mapping_math_#3\fi}%
  \DeclareFontFamily{\mathencodingdefault}{\umath@family}{}%
  \edef\umath@tmpa{\noexpand\DeclareFontShape
    {\mathencodingdefault}
    {\umath@family}
    {\mathseriesdefault}
    {\mathshapedefault}
    {<-\umath@sf>%
     s*[1.\umath@paddednum{\umath@scalecount+0}]%
     "\umathfontdecl:\umath@mode;script=math;+ssty=1;\umath@mapping;"%
     <\umath@sf-\umath@tf>%
     s*[1.\umath@paddednum{\umath@scalecount+1}]%
     "\umathfontdecl:\umath@mode;script=math;+ssty=0;\umath@mapping;"%
     <\umath@tf->%
     s*[1.\umath@paddednum{\umath@scalecount+2}]%
     "\umathfontdecl:\umath@mode;script=math;\umath@mapping;"}
    {}}\umath@tmpa
  \umath@scalecount=\numexpr\umath@scalecount+3\relax
  \ifdefined\directlua
    \expandafter\gdef\csname
        \mathencodingdefault/\umath@family/\mathseriesdefault/\mathshapedefault+preloadhook%
      \endcsname{\umath@fonthook{#3}}
  \fi
}

\def\umath@paddednum#1{%
  \ifnum\numexpr#1\relax<10 000\number\numexpr#1\relax\else
  \ifnum\numexpr#1\relax<100 00\number\numexpr#1\relax\else
  \ifnum\numexpr#1\relax<1000 0\number\numexpr#1\relax\fi\fi\fi
}

\def\DeclUSymbolFont#1#2#3#4{%
  \def\@tmpa{#4}\def\@tmpb{}%
  \ifx\@tmpa\@tmpb
    \def\umath@family{#3}%
  \else
    \def\umath@family{#3-map-#4}%
  \fi
  \ifcsname \mathencodingdefault+\umath@family\endcsname\else
    \DeclareMathFamily{#1}{#3}{#4}%
  \fi
  \DeclareSymbolFont
    {#2}
    {\mathencodingdefault}
    {\umath@family}
    {\mathseriesdefault}
    {\mathshapedefault}%
}
\def\DeclUMathAlph#1#2#3#4{%
  \def\@tmpa{#4}\def\@tmpb{}%
  \ifx\@tmpa\@tmpb
    \def\umath@family{#3}%
  \else
    \def\umath@family{#3-map-#4}%
  \fi
  \ifcsname \mathencodingdefault+\umath@family\endcsname\else
    \DeclareMathFamily{#1}{#3}{#4}%
  \fi
  \DeclareMathAlphabet
    {#2}
    {\mathencodingdefault}
    {\umath@family}
    {\mathseriesdefault}
    {\mathshapedefault}%
}


% need to fix all the NFSS math assignments

\def\Uset@mathchar#1#2#3#4{%
  \global\Umathcode`#2="\mathchar@type#3 #1 #4\relax}

\def\Uset@mathsymbol#1#2#3#4{%
  \global\Umathchardef#2 "\mathchar@type#3 #1 #4\relax}

\def\Uset@mathdelimiter#1#2#3#4{%
  \xdef#2{\Udelimiter "\mathchar@type#3 #1 #4\relax}%
}
\def\Uset@@mathdelimiter#1#2#3{%
  \global\Udelcode`#2=#1 #3\relax}


\def\uDeclareMathSymbol#1#2#3#4{%
  \expandafter\in@\csname sym#3\expandafter\endcsname
     \expandafter{\group@list}%
  \ifin@
    \begingroup
      \if\relax\noexpand#1% is command?
        \edef\reserved@a{\noexpand\in@{\string\mathchar}{\meaning#1}}%
        \reserved@a
        \ifin@
          \expandafter\Uset@mathsymbol
             \csname sym#3\endcsname{#1}{#2}{#4}%
          \@font@info{Redeclaring math symbol \string#1}%
        \else
            \expandafter\ifx
            \csname\expandafter\@gobble\string#1\endcsname
            \relax
            \expandafter\Uset@mathsymbol
               \csname sym#3\endcsname{#1}{#2}{#4}%
          \else
            \@latex@error{Command ‘\string#1’ already defined}\@eha
          \fi
\fi \else
        \expandafter\Uset@mathchar
          \csname sym#3\endcsname{#1}{#2}{#4}%
      \fi
    \endgroup
  \else
    \@latex@error{Symbol font ‘#3’ is not defined}\@eha
\fi
}




\def\uDeclareMathDelimiter#1{%
  \if\relax\noexpand#1%
    \expandafter\u@DeclareMathDelimiter
  \else
    \expandafter\u@xDeclareMathDelimiter
  \fi
  #1}

\def\u@DeclareMathDelimiter#1#2#3#4{%
  \expandafter\in@\csname sym#3\expandafter\endcsname
     \expandafter{\group@list}%
  \ifin@
      \begingroup
        \edef\reserved@a{\noexpand\in@{\string\delimiter}{\meaning#1}}%
        \reserved@a
        \ifin@
          \expandafter\Uset@mathdelimiter
             \csname sym#3\endcsname{#1}{#2}{#4}%
          \@font@info{Redeclaring math delimiter \string#1}%
        \else
            \expandafter\ifx
            \csname\expandafter\@gobble\string#1\endcsname
            \relax
            \expandafter\Uset@mathdelimiter
              \csname sym#3\endcsname{#1}{#2}{#4}%
          \else
            \@latex@error{Command `\string#1' already defined}\@eha
          \fi
        \fi
      \endgroup
  \else
    \@latex@error{Symbol font `#3' is not defined}\@eha
  \fi
}

\def\u@xDeclareMathDelimiter#1#2#3#4{%
  \expandafter\in@\csname sym#3\expandafter\endcsname
     \expandafter{\group@list}%
  \ifin@
      \begingroup
        \expandafter\Uset@@mathdelimiter
           \csname sym#3\endcsname{#1}{#4}%
      \endgroup
  \else
    \@latex@error{Symbol font `#3' is not defined}\@eha
  \fi
}



\def\uDeclareMathRadical#1#2#3{%
  \expandafter\ifx
       \csname\expandafter\@gobble\string#1\endcsname
       \relax
     \let#1\radical
  \fi
  \edef\reserved@a{\noexpand\in@{\string\radical}{\meaning#1}}%
  \reserved@a
  \ifin@
    \expandafter\in@\csname sym#2\expandafter\endcsname
       \expandafter{\group@list}%
    \ifin@
          \xdef#1{\Uradical \csname sym#2\endcsname\space#3\relax}%
    \else
      \@latex@error{Symbol font `#2' is not defined}\@eha
    \fi
  \else
    \@latex@error{Command `\string#1' already defined}\@eha
  \fi
}



\RequirePackage{umathsym2e}



\endinput

